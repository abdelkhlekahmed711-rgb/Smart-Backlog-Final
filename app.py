import streamlit as st
import pandas as pd
from datetime import date, timedelta

def academic_rescue_module():
    st.markdown("## ๐ ุบุฑูุฉ ุนูููุงุช ุงูุฅููุงุฐ ุงูุฃูุงุฏููู")
    st.info("ููุง ุณูููู ุจุชุญููู ุงูุชุฑุงููุงุช ุงููุฑุนุจุฉ ุฅูู ุฎุทุฉ ุนูู ููููุฉ ูุงุถุญุฉ.")

    # --- 1. ุฅุฏุฎุงู ุจูุงูุงุช ุงูุชุฑุงููุงุช (The Input) ---
    st.subheader("1๏ธโฃ ูุง ูู ุงูุชุฑุงููุงุช ุงูุญุงููุฉุ")
    
    # ุชููุฆุฉ ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
    if 'backlog_data' not in st.session_state:
        st.session_state.backlog_data = pd.DataFrame(
            [
                {"ุงููุงุฏุฉ": "ุงูููุฒูุงุก", "ุนุฏุฏ ุงูุฏุฑูุณ/ุงููุญุงุถุฑุงุช": 5, "ูุชูุณุท ููุช ุงูุฏุฑุณ (ุณุงุนุฉ)": 2.5},
                {"ุงููุงุฏุฉ": "ุงูุฑูุงุถูุงุช", "ุนุฏุฏ ุงูุฏุฑูุณ/ุงููุญุงุถุฑุงุช": 3, "ูุชูุณุท ููุช ุงูุฏุฑุณ (ุณุงุนุฉ)": 2.0},
            ]
        )

    # ุฌุฏูู ูุงุจู ููุชุนุฏูู ูุฅุถุงูุฉ ุงูููุงุฏ
    edited_df = st.data_editor(
        st.session_state.backlog_data,
        num_rows="dynamic",
        use_container_width=True,
        column_config={
            "ูุชูุณุท ููุช ุงูุฏุฑุณ (ุณุงุนุฉ)": st.column_config.NumberColumn(
                "ูุชูุณุท ููุช ุงูุฏุฑุณ (ุณุงุนุฉ)",
                help="ูู ุณุงุนุฉ ูุณุชุบุฑู ุงูุฏุฑุณ ุงููุงุญุฏ ุจุงููุฐุงูุฑุฉุ",
                min_value=0.5,
                max_value=10.0,
                step=0.5,
                format="%.1f ุณ"
            )
        }
    )

    # --- 2. ุชุญุฏูุฏ ุงููุฏู (The Goal) ---
    st.subheader("2๏ธโฃ ูุชู ุชุฑูุฏ ุฃู ุชููู ุญุฑุงู ุชูุงูุงูุ")
    
    col1, col2 = st.columns(2)
    with col1:
        deadline_date = st.date_input(
            "ุชุงุฑูุฎ ุงูุงูุชูุงุก ูู ุงูุชุฑุงููุงุช (Deadline)",
            min_value=date.today() + timedelta(days=1), # ูุฌุจ ุฃู ูููู ุงูุชุงุฑูุฎ ุบุฏุงู ุนูู ุงูุฃูู
            value=date.today() + timedelta(days=7)
        )
    
    # --- 3. ุงููุญุฑู ุงูุญุณุงุจู (The Engine) ---
    if st.button("๐ ุงุญุณุจ ุฎุทุฉ ุงูุฅููุงุฐ ุงูุขู"):
        
        # 1. ุญุณุงุจ ุฅุฌูุงูู ุงูุณุงุนุงุช ุงููุทููุจุฉ ููู ูุงุฏุฉ
        # ูููู ุจุฅูุดุงุก ูุณุฎุฉ ูุชุฌูุจ ุงูุชุนุฏูู ุนูู ุงูุจูุงูุงุช ุงูุฃุตููุฉ
        calc_df = edited_df.copy()
        calc_df["ุฅุฌูุงูู ุงูุณุงุนุงุช"] = calc_df["ุนุฏุฏ ุงูุฏุฑูุณ/ุงููุญุงุถุฑุงุช"] * calc_df["ูุชูุณุท ููุช ุงูุฏุฑุณ (ุณุงุนุฉ)"]
        
        total_backlog_hours = calc_df["ุฅุฌูุงูู ุงูุณุงุนุงุช"].sum()
        
        # 2. ุญุณุงุจ ุงูุฃูุงู ุงููุชุจููุฉ
        days_remaining = (deadline_date - date.today()).days
        
        if total_backlog_hours == 0:
            st.success("๐ ูุจุฑูู! ููุณ ูุฏูู ุฃู ุชุฑุงููุงุช. ุงุฐูุจ ูุงุณุชูุชุน ุจูููู!")
            return

        # 3. ุญุณุงุจ ุงูุณุงุนุงุช ุงูููููุฉ ุงููุทููุจุฉ (ุงูุฌุฑุนุฉ ุงูููููุฉ)
        daily_hours_needed = total_backlog_hours / days_remaining
        
        st.divider()
        st.markdown("### ๐ ุชูุฑูุฑ ุงูุญุงูุฉ:")
        
        # ุนุฑุถ ุงูููุงููุณ (Metrics)
        m1, m2, m3 = st.columns(3)
        m1.metric("ุฅุฌูุงูู ุณุงุนุงุช ุงูุชุฑุงูู", f"{total_backlog_hours:.1f} ุณุงุนุฉ")
        m2.metric("ุงูุฃูุงู ุงููุชุจููุฉ", f"{days_remaining} ููู")
        m3.metric("ุงููุทููุจ ููููุงู", f"{daily_hours_needed:.1f} ุณุงุนุฉ/ููู")
        
        # --- 4. ููุทู ุชูููู ุงูุฎุทุฉ (Feasibility Check) ---
        st.subheader("๐ก ุงูุญูู ุงูููุงุฆู ุนูู ุฎุทุชู:")
        
        # ุชุตููู ุตุนูุจุฉ ุงูุฎุทุฉ
        if daily_hours_needed <= 3:
            st.success(f"โ **ุฎุทุฉ ูุฑูุญุฉ:** ุชุญุชุงุฌ ููุฐุงูุฑุฉ {daily_hours_needed:.1f} ุณุงุนุฉ ุฅุถุงููุฉ ููููุงู. ููููู ูุนููุง ุจุณูููุฉ!")
            st.progress(daily_hours_needed / 12, text="ูุณุชูู ุงูุถุบุท: ููุฎูุถ")
            
        elif 3 < daily_hours_needed <= 8:
            st.warning(f"โ๏ธ **ุฎุทุฉ ูุชุงููุฉ:** ุชุญุชุงุฌ {daily_hours_needed:.1f} ุณุงุนุฉ ููููุงู ููุท ููุชุฑุงููุงุช (ุบูุฑ ูุฐุงูุฑุฉ ุงูุฌุฏูุฏ). ุชุญุชุงุฌ ุงูุชุฒุงู ุญุฏูุฏู!")
            st.progress(daily_hours_needed / 12, text="ูุณุชูู ุงูุถุบุท: ูุชูุณุท ุฅูู ูุฑุชูุน")
            
        else:
            st.error(f"โ **ุฎุทุฉ ุงูุชุญุงุฑูุฉ (ุบูุฑ ูุงูุนูุฉ):** ุชุชุทูุจ {daily_hours_needed:.1f} ุณุงุนุฉ ููููุงู! ูุฐุง ูุณุชุญูู ุนูููุงู.")
            st.markdown("""
            **ุงูุญู ุงูููุชุฑุญ:**
            1. ูู ุจูุฏ "ุชุงุฑูุฎ ุงูุงูุชูุงุก" ูุฃูุงู ุฅุถุงููุฉ.
            2. ุฃู ูู ุจุชูููู ุฌูุฏุฉ ุงููุฐุงูุฑุฉ ููููุงู (ูุฐุงูุฑุฉ ุณุฑูุนุฉ) ูุชูููู ููุช ุงููุญุงุถุฑุฉ.
            """)
            st.progress(1.0, text="ูุณุชูู ุงูุถุบุท: ุญุฑุฌ ุฌุฏุงู")

        # ุนุฑุถ ุชูุงุตูู ุงูููุงุฏ
        st.write("---")
        st.caption("ุชูุงุตูู ุงูุณุงุนุงุช ููู ูุงุฏุฉ:")
        st.dataframe(calc_df[["ุงููุงุฏุฉ", "ุฅุฌูุงูู ุงูุณุงุนุงุช"]], use_container_width=True)

# ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ูุชุดุบูููุง (ููุท ููุชุฌุฑุจุฉ ููุงุ ูู ุจุฑูุงูุฌู ุณุชุถุนูุง ูู ุงูููุงู ุงูููุงุณุจ)
if __name__ == "__main__":
    academic_rescue_module()